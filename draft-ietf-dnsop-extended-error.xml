<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY rfc2119 PUBLIC "" ".//reference.RFC.2119.xml">
]>
<!-- WK: Set category, IPR, docName -->
<rfc category="std" docName="draft-ietf-dnsop-extended-error-09"
     ipr="trust200902">
  <?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

  <?rfc toc="yes" ?>

  <?rfc symrefs="yes" ?>

  <?rfc sortrefs="yes"?>

  <?rfc iprnotified="no" ?>

  <?rfc strict="yes"?>

  <?rfc compact="yes" ?>
  <?rfc subcompact="yes" ?>

  <front>
    <!-- WK: Set long title. -->

    <title abbrev="draft-ietf-dnsop-extended-error">Extended DNS
    Errors</title>

    <author fullname="Warren Kumari" initials="W." surname="Kumari">
      <organization>Google</organization>

      <address>
        <postal>
          <street>1600 Amphitheatre Parkway</street>

          <city>Mountain View, CA</city>

          <code>94043</code>

          <country>US</country>
        </postal>

        <email>warren@kumari.net</email>
      </address>
    </author>

    <author fullname="Evan Hunt" initials="E." surname="Hunt">
      <organization>ISC</organization>

      <address>
        <postal>
          <street>950 Charter St</street>

          <city>Redwood City, CA</city>

          <code>94063</code>

          <country>US</country>
        </postal>

        <email>each@isc.org</email>
      </address>
    </author>

    <author fullname="Roy Arends" initials="R." surname="Arends">
      <organization>ICANN</organization>

      <address>
        <postal>
          <street/>
        </postal>

        <email>roy.arends@icann.org</email>
      </address>
    </author>

    <author fullname="Wes Hardaker" initials="W." surname="Hardaker">
      <organization>USC/ISI</organization>

      <address>
        <postal>
          <street>P.O. Box 382</street>

          <city>Davis, CA</city>

          <code>95617</code>

          <country>US</country>
        </postal>

        <email>ietf@hardakers.net</email>
      </address>
    </author>

    <author fullname="David C Lawrence" initials="D." surname="Lawrence">
      <organization>Oracle + Dyn</organization>

      <address>
        <postal>
          <street>150 Dow St</street>

          <city>Manchester, NH</city>

          <code>03101</code>

          <country>US</country>
        </postal>

        <email>tale@dd.org</email>
      </address>
    </author>

    <date day="10" month="September" year="2019"/>

    <abstract>
      <t>This document defines an extensible method to return
      additional information about the cause of DNS errors. Though
      created primarily to extend SERVFAIL to provide additional
      information about the cause of DNS and DNSSEC failures, the
      Extended DNS Errors option defined in this document allows all
      response types to contain extended error information. Extended
      DNS Error information does not change the processing of RCODEs.</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction and background">
      <t>There are many reasons that a DNS query may fail, some of
      them transient, some permanent; some can be resolved by querying
      another server, some are likely best handled by stopping
      resolution.  Unfortunately, the error signals that a DNS server
      can return are very limited, and are not very expressive. This
      means that applications and resolvers often have to "guess" at
      what the issue is - e.g. was the answer marked REFUSED because
      of a lame delegation, or because the nameserver is still
      starting up and loading zones? Is a SERVFAIL a DNSSEC validation
      issue, or is the nameserver experiencing some other failure?</t>

      <t>A good example of issues that would benefit by additional
      error information are errors caused by DNSSEC validation
      issues. When a stub resolver queries a name which is DNSSEC
      bogus (using a validating resolver), the stub resolver receives
      only a SERVFAIL in response. Unfortunately, the SERVFAIL
      Response Code (RCODE) is used to signal many sorts of DNS
      errors, and so the stub resolvers only option is to ask the next
      configured DNS resolver. The result of trying the next resolver
      is one of two outcomes: either the next resolver also validates,
      and a SERVFAIL is returned again or the next resolver is not a
      validating resolver, and the user is returned a potentially
      harmful result.  With an Extended DNS Error (EDE) option
      enclosed in the response message, the resolver is able to return
      a more descriptive reason as to why any failures happened, or
      add additional context to a message containing a NOERROR
      RCODE.</t>

      <t>This document specifies a mechanism to extend DNS errors to
      provide additional information about the cause of an error.
      These extended DNS error codes described in this document and can be
      used by any system that sends DNS queries and receives a
      response containing an EDE option. Different codes are useful
      in different circumstances, and thus different systems (stub
      resolvers, recursive resolvers, and authoritative resolvers)
      might receive and use them.</t>

      <t>This document does not allow or prohibit any particular
      extended error codes and information to be matched with any
      particular RCODEs. Some combinations of extended error codes and
      RCODEs may seem nonsensical (such as resolver-specific extended
      error codes in responses from authoritative servers), so systems
      interpreting the extended error codes MUST NOT assume that a
      combination will make sense.  Receivers MUST be able to accept
      EDE codes and EXTRA-TEXT in all messages, including those with a
      NOERROR RCODE.  Receivers MUST NOT change the processing of
      RCODEs in messages based on extended error codes.</t>

      <section title="Requirements notation">
        <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
        "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
        document are to be interpreted as described in <xref
        target="RFC2119"/>.</t>
      </section>
    </section>

    <section title="Extended Error EDNS0 option format">
      <t>This draft uses an EDNS0 (<xref target="RFC2671" />) option to include
      Extended DNS Error (EDE) information in DNS messages. The option
      is structured as follows:</t>

      <figure>
        <artwork align="left"><![CDATA[
                                             1   1   1   1   1   1
     0   1   2   3   4   5   6   7   8   9   0   1   2   3   4   5  
   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
0: |                            OPTION-CODE                        |
   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
2: |                           OPTION-LENGTH                       |
   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
4: | INFO-CODE                                                     |
   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
6: / EXTRA-TEXT ...                                                /
   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
]]></artwork>
      </figure>

      <t/>

      <t>Field definition details:</t>

      <t><list style="symbols">
          <t>OPTION-CODE, 2 octets (defined in <xref target="RFC6891"
          />]), for EDE is TBD.
          [RFC Editor: change TBD to the proper code once assigned by IANA.]</t>

          <t>OPTION-LENGTH, 2 octets ((defined in <xref
          target="RFC6891" />]) contains
          the length of the payload (everything after OPTION-LENGTH)
          in octets and should be 4 plus the length of the EXTRA-TEXT
          section (which may be a zero-length string).</t>

          <t>INFO-CODE, 16-bits, which is the principal contribution
          of this document.  This 16-bit value, encoded in network
          (MSB) byte order, provides the additional context for the
          RESPONSE-CODE of the DNS message. The INFO-CODE serves as an
          index into the "Extended DNS Errors" registry <xref
          target="IANA" />.</t>

          <t>EXTRA-TEXT, a variable length, UTF-8 encoded, text field
          that may hold additional textual information.  Note:
          EXTRA-TEXT may be zero octets in length, indicating there is
          no EXTRA-TEXT included.  Care should be taken not to leak
          private information that an observer would not otherwise
          have access to, such as account numbers.</t>
        </list></t>

      <t>The Extended DNS Error (EDE) option can be included in any
      response (SERVFAIL, NXDOMAIN, REFUSED, and even NOERROR, etc) to
      a query that includes OPT Pseudo-RR <xref target="RFC6891" />.
      This document includes a set of initial codepoints (and requests
      to the IANA to add them to the registry), but is extensible via
      the IANA registry to allow additional error and information
      codes to be defined in the future.</t>

    </section>

    <section title="Defined Extended DNS Errors">
      <t>This document defines some initial EDE codes. The mechanism
      is intended to be extensible, and additional code-points can be
      registered in the "Extended DNS Errors" registry <xref
      target="IANA" />.  The INFO-CODE from the EDE EDNS option is
      used to serve as an index into the "Extended DNS Error" IANA
      registry, the initial values for which are defined in the
      following sub-sections.</t>

      <section anchor="errother" title="Extended DNS Error Code 0 - Other">
	      <t>The error in question falls into a category that does
	      not match known extended error codes.  Implementations
	      SHOULD include a EXTRA-TEXT value to augment this error
	      code with additional information.</t>
      </section>

        <section anchor="errbaddnskeyalg"
                 title="Extended DNS Error Code 1 -
                        Unsupported DNSKEY Algorithm">
          <t>The resolver attempted to perform DNSSEC validation, but a DNSKEY
          RRSET contained only unknown DNSSEC algorithms.</t>
        </section>

        <section anchor="errbaddsdigest"
                 title="Extended DNS Error Code 2 - Unsupported DS
                        Digest Type">
          <t>The resolver attempted to perform DNSSEC validation, but a DS
          RRSET contained only unknown Digest Types.</t>
        </section>

        <section anchor="stalenoerror"
	         title="Extended DNS Error Code 3 - Stale Answer">
          <t>The resolver was unable to resolve answer within its time
          limits and decided to answer with previously cached data
          instead of answering with an error.  This is typically
          caused by problems communicating with an authoritative
          serever, possibly as result of a DoS attack against another
          network.</t>
        </section>

        <section anchor="forgedanswer"
                 title="Extended DNS Error Code 4 - Forged Answer">
          <t>For policy reasons (legal obligation, or malware
          filtering, for instance), an answer was forged.</t>
        </section>

        <section anchor="errindeterminate"
                 title="Extended DNS Error Code 5 - DNSSEC Indeterminate">
          <t>The resolver attempted to perform DNSSEC validation, but
          validation ended in the Indeterminate state <xref
          target="RFC4035" />.</t>
        </section>

        <section anchor="errbogus"
                 title="Extended DNS Error Code 6 - DNSSEC Bogus">
          <t>The resolver attempted to perform DNSSEC validation, but
          validation ended in the Bogus state.</t>
        </section>

        <section anchor="errexpired"
                 title="Extended DNS Error Code 7 - Signature Expired">
          <t>The resolver attempted to perform DNSSEC validation, but all
          signatures in an RRset in the validation chain were expired.</t>
        </section>

        <section anchor="errprior"
                 title="Extended DNS Error Code 8 - Signature Not Yet Valid">
          <t>The resolver attempted to perform DNSSEC validation, but
          all the signatures received were not yet valid.</t>
        </section>

        <section anchor="errnodnskey"
                 title="Extended DNS Error Code 9 - DNSKEY Missing">
          <t>A DS record existed at a parent, but no supported
          matching DNSKEY record could be found for the child.</t>
        </section>

        <section anchor="errnorrsig"
                 title="Extended DNS Error Code 10 - RRSIGs Missing">
          <t>The resolver attempted to perform DNSSEC validation, but no
          RRSIGs could be found for at least one RRset where RRSIGs were
          expected.</t>
        </section>

        <section anchor="errnozonekey"
                 title="Extended DNS Error Code 11 - No Zone Key Bit Set">
          <t>The resolver attempted to perform DNSSEC validation, but no Zone
          Key Bit was set in a DNSKEY.</t>
        </section>

        <section anchor="nonsec"
                 title="Extended DNS Error Code 12 - NSEC Missing">
          <t>The resolver attempted to perform DNSSEC validation, but
          the requested data was missing and a covering NSEC or NSEC3
          was not provided.</t>
        </section>

        <section anchor="cachederror"
                 title="Extended DNS Error Code 13 - Cached Error">
          <t>The resolver has cached SERVFAIL for this query.</t>
        </section>

        <section anchor="notready"
                 title="Extended DNS Error Code 14 - Not Ready">
          <t>The server is unable to answer the query as it is not
          fully functional (yet).</t>
        </section>


        <section anchor="errblocked"
	         title="Extended DNS Error Code 15 - Blocked">
          <t>The resolver attempted to perfom a DNS query but the
          domain is blacklisted due to a security policy implemented
          on the server being directly talked to.</t>
        </section>

        <section anchor="errcensored"
	         title="Extended DNS Error Code 16 - Censored">
          <t>The resolver attempted to perfom a DNS query but the
          domain was blacklisted by a security policy imposed upon the
          server being talked to. Note that how the imposed policy is
          applied is irrelevant (in-band DNS filtering, court order,
          etc).</t>
        </section>

        <section anchor="errprohibted"
	         title="Extended DNS Error Code 17 - Prohibited">
          <t>An authoritative or recursive resolver that receives a query from
          an "unauthorized" client can annotate its REFUSED message with this
          code. Examples of "unauthorized" clients are recursive queries from
          IP addresses outside the network, blacklisted IP addresses, local
          policy, etc.</t>
        </section>

        <section anchor="errfiltered"
	         title="Extended DNS Error Code 18 - Filtered">
          <t>An authoritative or recursive resolver that receives a
          query from a client that had requested certain domains be
          filtered can annotate its REFUSED message with this code.
          Functionally, this amounts to "you requested that we filter
          domains like this one."</t>
        </section>

        <section anchor="stalenx"
	         title="Extended DNS Error Code 19 - Stale NXDOMAIN Answer">
          <t>The resolver was unable to resolve an answer within its
          configured time limits and decided to answer with a
          previously cached NXDOMAIN answer instead of answering with
          an error. This is typically caused by problems communicating
          with an authoritative server, possibly as result of a DoS
          attack against another network.</t>

        </section>

	<section anchor="errlame"
	         title="Extended DNS Error Code 20 - Lame">
          <t>An authoritative server that receives a query (with the
          RD bit clear) for a domain for which it is not authoritative
          SHOULD include this EDE code in the SERVFAIL response.  A
          resolver that receives a query (with the RD bit clear)
          SHOULD include this EDE code in the REFUSED
          response.</t>
        </section>



	<section anchor="deprecated"
	         title="Extended DNS Error Code 21 - Deprecated">
          <t>The requested operation or query is not supported as its
          use has been deprecated.</t>
        </section>

        <section anchor="noreachable"
                 title="Extended DNS Error Code 22 - No Reachable Authority">
          <t>The resolver could not reach any of the authoritative name servers
          (or they refused to reply).</t>
        </section>

        <section anchor="networkerror"
                 title="Extended DNS Error Code 23 - Network Error">
          <t>An unrecoverable error occurred while communicating with
          another server.</t>
        </section>
      </section>

    <section title="IANA Considerations">
      <section title="A New Extended DNS Error Code EDNS Option" anchor="IANA">

        <t>This document defines a new EDNS(0) option, entitled
        "Extended DNS Error", assigned a value of TBD1 from the "DNS
        EDNS0 Option Codes (OPT)" registry [to be removed upon
        publication:
        [http://www.iana.org/assignments/dns-parameters/dns-parameters.xhtml#dns-parameters-11]</t>

        <t><figure>
            <artwork><![CDATA[Value  Name                 Status    Reference
-----  ----------------     ------    ------------------
 TBD   Extended DNS Error    TBD       [ This document ]]]></artwork>
          </figure></t>
      </section>

      <section title="New Registry Table for Extended DNS Error Codes">
        <t>This document defines a new IANA registry
        table, where the index value is the INFO-CODE from the
        "Extended DNS Error" EDNS option defined in this document. The
        IANA is requested to create and maintain this "Extended DNS
        Error" codes registry. The code-point space for the INFO-CODE
        index is to be broken into 3 ranges:</t>

        <t><list style="symbols">
            <t>0 - 32767: Expert Review <xref target="RFC2434" />.</t>

            <t>32768 - 49151: First come, first served.</t>

            <t>49152 - 65535: Experimental / Private use.</t>
        </list></t>

        <t>A starting set of entries, based on the contents of this
        document, is as follows:</t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">0</t>
    <t hangText="Purpose:">Other Error</t>
    <t hangText="Reference:"><xref target="errother" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">1</t>
    <t hangText="Purpose:">Unsupported DNSKEY Algorithm</t>
    <t hangText="Reference:"><xref target="errbaddnskeyalg" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">2</t>
    <t hangText="Purpose:">Unsupported DS Digest Type</t>
    <t hangText="Reference:"><xref target="errbaddsdigest" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">3</t>
    <t hangText="Purpose:">Stale Answer</t>
    <t hangText="Reference:"><xref target="stalenoerror" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">4</t>
    <t hangText="Purpose:">Forged Answer</t>
    <t hangText="Reference:"><xref target="forgedanswer" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">5</t>
    <t hangText="Purpose:">DNSSEC Indeterminate</t>
    <t hangText="Reference:"><xref target="errindeterminate" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">6</t>
    <t hangText="Purpose:">DNSSEC Bogus</t>
    <t hangText="Reference:"><xref target="errbogus" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">7</t>
    <t hangText="Purpose:">Signature Expired</t>
    <t hangText="Reference:"><xref target="errexpired" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">8</t>
    <t hangText="Purpose:">Signature Not Yet Valid</t>
    <t hangText="Reference:"><xref target="errprior" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">9</t>
    <t hangText="Purpose:">DNSKEY Missing</t>
    <t hangText="Reference:"> <xref target="errnodnskey" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">10</t>
    <t hangText="Purpose:">RRSIGs Missing</t>
    <t hangText="Reference:"><xref target="errnorrsig" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">11</t>
    <t hangText="Purpose:">No Zone Key Bit Set</t>
    <t hangText="Reference:"><xref target="errnozonekey" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">12</t>
    <t hangText="Purpose:">NSEC Missing</t>
    <t hangText="Reference:"><xref target="nonsec" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">13</t>
    <t hangText="Purpose:">Cached Error</t>
    <t hangText="Reference:"><xref target="cachederror" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">14</t>
    <t hangText="Purpose:">Not Ready.</t>
    <t hangText="Reference:"><xref target="notready" /></t>
    </list></t>
    
    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">15</t>
    <t hangText="Purpose:">Blocked</t>
    <t hangText="Reference:"><xref target="errblocked" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">16</t>
    <t hangText="Purpose:">Censored</t>
    <t hangText="Reference:"><xref target="errcensored" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">17</t>
    <t hangText="Purpose:">Prohibited</t>
    <t hangText="Reference:"><xref target="errprohibted" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">18</t>
    <t hangText="Purpose:">Filtered</t>
    <t hangText="Reference:"><xref target="errfiltered" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">19</t>
    <t hangText="Purpose:">Stale NXDomain Answer</t>
    <t hangText="Reference:"><xref target="stalenx" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">20</t>
    <t hangText="Purpose:">Lame</t>
    <t hangText="Reference:"><xref target="errlame" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">21</t>
    <t hangText="Purpose:">Deprecated</t>
    <t hangText="Reference:"><xref target="deprecated" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">22</t>
    <t hangText="Purpose:">No Reachable Authority</t>
    <t hangText="Reference:"><xref target="noreachable" /></t>
    </list></t>

    <t><list style="hanging" hangIndent="10">
    <t hangText="INFO-CODE:">23</t>
    <t hangText="Purpose:">Network Error</t>
    <t hangText="Reference:"><xref target="networkerror" /></t>
    </list></t>
      </section>
    </section>

    <section anchor="security" title="Security Considerations">
      <t>Though DNSSEC continues to be deployed, unfortunately a
      significant number of clients (~11% according to <xref
      target="GeoffValidation"/>) that receive a SERVFAIL from a
      validating resolver because of a DNSSEC validaion issue will
      simply ask the next (potentially non-validating) resolver in
      their list, and thus don't get any of the protections which
      DNSSEC should provide.</t>

      <t>This information is unauthenticated information, and an attacker (e.g
      a MITM or malicious recursive server) could insert an extended error
      response into already untrusted data &mdash; ideally clients and
      resolvers would not trust any unauthenticated information, but until we
      live in an era where all DNS answers are authenticated via DNSSEC or
      other mechanisms <xref target="RFC2845" /> <xref target="RFC8094" />, 
      there are some tradeoffs. As an example, an attacker
      who is able to insert the DNSSEC Bogus Extended Error into a packet
      could instead simply reply with a fictitious address (A or AAAA) record.
      </t>
    </section>

    <section title="Acknowledgements">
      <t>The authors wish to thank Joe Abley, Mark Andrews, Vittorio
      Bertola, Stephane Bortzmeyer, Vladimir Cunat, Ralph Dolmans,
      Peter DeVries, Peter van Dijk, Donald Eastlake, Bob Harold, Paul
      Hoffman, Geoff Huston, Shane Kerr, Edward Lewis, Carlos M.
      Martinez, George Michelson, Michael Sheldon, Puneet Sood, Petr
      Spacek, Ondrej Sury, John Todd, Loganaden Velvindron, and Paul
      Vixie.  They also vaguely remember discussing this with a number
      of people over the years, but have forgotten who all they were
      -- if you were one of them, and are not listed, please let us
      know and we'll acknowledge you.</t>

      <t>One author also wants to thank the band "Infected Mushroom"
      for providing a good background soundtrack (and to see if he can
      get away with this in an RFC!)  Another author would like to
      thank the band "Mushroom Infectors". This was funny at the time
      we wrote it, but we cannot remember why...</t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      <?rfc include='reference.RFC.2119'?>
      <?rfc include='reference.RFC.2434'?>
      <?rfc include='reference.RFC.2671'?>
      <?rfc include='reference.RFC.6891'?>
    </references>

    <references title="Informative References">
      <?rfc include='reference.RFC.2845' ?>

      <?rfc include='reference.RFC.8094' ?>

      <reference anchor="GeoffValidation"
                 target="http://www.potaroo.net/presentations/2016-06-27-dnssec.pdf">
        <front>
          <title abbrev="Validation today">A quick review of DNSSEC Validation
          in today&rsquo;s Internet</title>

          <author fullname="Geoff Huston, APNIC">
            <organization>IANA</organization>
          </author>

          <date month="June" year="2016"/>
        </front>
      </reference>
    </references>
  </back>
</rfc>
